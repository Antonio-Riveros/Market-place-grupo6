{% extends "base.html" %}
{% block title %}Productos ‚Ä¢ Mercadito{% endblock %}

{% block content %}
<section class="catalog-header text-center py-5 mb-4">
  <h2 class="fw-bold display-6 text-primary">Cat√°logo de Productos</h2>
  <p class="text-muted mt-2">Descubr√≠ lo mejor del Mercadito, todo en un solo lugar</p>

  {% if user.is_authenticated %}
  <a href="{% url 'market:productcreate' %}" class="btn btn-success mt-3 px-4 py-2 rounded-pill shadow-sm fw-semibold">
    + Publicar nuevo producto
  </a>
  {% endif %}
</section>

<div class="container py-4">
  <!-- FILTROS (MANTENIDOS DE LA VERSI√ìN ANTERIOR) -->
  <details class="filter-panel card shadow-sm border-0 mb-5 p-3 bg-light">
    <summary class="fw-bold text-primary mb-3">Filtrar productos por:</summary>
    <form method="get" class="row align-items-center justify-content-center gy-3">
      <div class="col-md-4 col-sm-6">
        <label for="category" class="form-label fw-semibold">üè∑Ô∏è Categor√≠a</label>
        <select name="category" id="category" class="form-select">
          <option value="">Todas</option>
          {% for cat in categories %}
          <option value="{{ cat }}" {% if request.GET.category == cat %}selected{% endif %}>
            {{ cat|capfirst }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4 col-sm-6">
        <label for="order" class="form-label fw-semibold">üí≤ Ordenar por precio</label>
        <select name="order" id="order" class="form-select">
          <option value="">Sin ordenar</option>
          <option value="asc" {% if request.GET.order == "asc" %}selected{% endif %}>Menor a Mayor</option>
          <option value="desc" {% if request.GET.order == "desc" %}selected{% endif %}>Mayor a Menor</option>
        </select>
      </div>

      <div class="col-md-2 text-center">
        <button type="submit" class="btn btn-primary w-100 rounded-pill shadow-sm mt-3 mt-md-0 fw-semibold">
          Aplicar
        </button>
      </div>
    </form>
  </details>

  <!-- PRODUCTOS (MANTENIDOS DE LA VERSI√ìN ANTERIOR) -->
  <div class="row g-4">
    {% for product in products %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
      <div class="card h-100 border-0 shadow-sm product-card position-relative overflow-hidden">
        {% if product.image %}
        <div class="product-img-wrapper">
          <img src="{{ product.image.url }}" class="card-img-top product-img" alt="{{ product.title }}">
        </div>
        {% else %}
        <div class="bg-secondary text-white text-center py-5 rounded-top">
          <i class="bi bi-box-seam fs-1"></i>
        </div>
        {% endif %}

        <div class="card-body text-center d-flex flex-column">
          <h5 class="card-title fw-bold text-dark mb-2">{{ product.title }}</h5>
          <p class="text-muted small flex-grow-1">{{ product.description|truncatewords:18 }}</p>
          <p class="fs-5 fw-bold text-success mb-3 price-tag">${{ product.price }}</p>

          {% if user.is_authenticated %}
          <button class="btn btn-primary rounded-pill w-100 fw-semibold add-to-cart-btn" data-id="{{ product.id }}">
            Agregar al carrito
          </button>

          {% if user == product.seller %}
          <div class="d-flex justify-content-center gap-2 mt-2">
            <a href="{% url 'market:product-edit' product.id %}" class="btn btn-warning text-white btn-sm rounded-pill px-3">‚úèÔ∏è</a>
            <button class="btn btn-danger btn-sm rounded-pill px-3 js-open-delete-modal"
                    data-delete-url="{% url 'market:product-delete' product.id %}"
                    data-product-title="{{ product.title|escapejs }}">
              üóëÔ∏è
            </button>
          </div>
          {% endif %}
          {% else %}
          <a href="{% url 'account_login' %}" class="btn btn-outline-secondary rounded-pill w-100">
            Inici√° sesi√≥n para comprar
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    {% empty %}
    <p class="text-center text-muted mt-5">No hay productos disponibles.</p>
    {% endfor %}
  </div>
</div>

<!-- Modal √∫nico para confirmar eliminaci√≥n (MANTENIDO DE LA VERSI√ìN ANTERIOR) -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header bg-danger text-white rounded-top-4">
        <h5 class="modal-title fw-bold" id="deleteModalLabel">‚ö†Ô∏è Confirmar eliminaci√≥n</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center py-4">
        <p class="fs-5 text-dark mb-0">
          ¬øEst√°s seguro de que quer√©s eliminar <strong id="deleteModalProductTitle"></strong>?
        </p>
      </div>

      <div class="modal-footer justify-content-center border-0 pb-4">
        <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
        <form id="deleteModalForm" method="post" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger rounded-pill px-4">Eliminar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Toasts (MANTENIDOS DE LA VERSI√ìN ANTERIOR) -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 2000;">
  <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert">
    <div class="d-flex">
      <div class="toast-body">Producto agregado al carrito ‚úì</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  <div id="toastError" class="toast align-items-center text-bg-danger border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body">‚ö†Ô∏é No se pudo conectar con el servidor.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
{{ block.super }}  <!-- üëà MANTIENE EL JS DEL CARRITO MEJORADO -->
<script>
// Funci√≥n para obtener el token CSRF (MEJORA NUEVA)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener("DOMContentLoaded", () => {
    const toastSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
    const toastError = new bootstrap.Toast(document.getElementById('toastError'));

    // --- AGREGAR AL CARRITO - VERSI√ìN MEJORADA ---
    document.querySelectorAll(".add-to-cart-btn").forEach(btn => {
        // Remover event listeners anteriores para evitar duplicados (MEJORA NUEVA)
        btn.replaceWith(btn.cloneNode(true));
    });

    // Re-asignar event listeners a los botones nuevos
    document.querySelectorAll(".add-to-cart-btn").forEach(btn => {
        btn.addEventListener("click", function handleCartClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Si ya est√° procesando, ignorar clics adicionales (MEJORA NUEVA)
            if (this.disabled) return;
            
            const productId = this.dataset.id;
            const originalText = this.innerHTML;
            
            this.disabled = true;
            this.innerHTML = "Agregando...";
            
            console.log("üõí Agregando producto:", productId);
            
            // ‚úÖ USANDO POST EN LUGAR DE GET (MEJORA DE SEGURIDAD)
            fetch(`/market/add/${productId}/`, {
                method: "POST",
                headers: { 
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": getCookie("csrftoken")  // üëà CSRF TOKEN AGREGADO
                }
            })
            .then(response => response.json())
            .then(data => {
                this.innerHTML = originalText;
                this.disabled = false;
                
                if (data.success) {
                    toastSuccess.show();
                    console.log("‚úÖ Producto agregado:", data.product);
                    
                    // üõí NOTIFICAR AL CARRITO QUE SE ACTUALICE (MEJORA NUEVA)
                    const productAddedEvent = new Event('productAddedToCart');
                    document.dispatchEvent(productAddedEvent);
                    
                    // Tambi√©n disparar el evento gen√©rico por si acaso
                    const cartUpdatedEvent = new Event('cartUpdated');
                    document.dispatchEvent(cartUpdatedEvent);
                } else {
                    toastError.show();
                }
            })
            .catch((error) => {
                this.innerHTML = originalText;
                this.disabled = false;
                toastError.show();
                console.error("‚ùå Error:", error);
            });
        });
    });

    // --- MODAL DE ELIMINACI√ìN (MANTENIDO DE LA VERSI√ìN ANTERIOR) ---
    const modalEl = document.getElementById('deleteModal');
    const deleteModal = new bootstrap.Modal(modalEl, {
        backdrop: true,
        keyboard: true
    });

    const modalForm = document.getElementById('deleteModalForm');
    const titleEl = document.getElementById('deleteModalProductTitle');

    document.querySelectorAll('.js-open-delete-modal').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const deleteUrl = btn.dataset.deleteUrl;
            const productTitle = btn.dataset.productTitle || 'este producto';
            titleEl.textContent = productTitle;
            modalForm.action = deleteUrl;
            deleteModal.show();
        });
    });

    // --- CERRAR MODAL CORRECTAMENTE (MANTENIDO DE LA VERSI√ìN ANTERIOR) ---
    modalEl.addEventListener('hidden.bs.modal', () => {
        document.body.classList.remove('modal-open');
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.remove();
    });
});
</script>

<style>
:root {
  --primary: #007bff;
  --primary-dark: #0056b3;
  --bg-light: #f5f7fb;
  --accent: #e8edf3;
}

/* ===== HERO ===== */
.catalog-header {
  background: linear-gradient(135deg, var(--accent), #f9fbfd);
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  max-width: 900px;
  margin: 0 auto;
}

/* ===== FILTROS ===== */
.filter-panel summary {
  cursor: pointer;
  list-style: none;
  font-size: 1.1rem;
}
.filter-panel summary::marker { display: none; }
.filter-panel form { margin-top: 10px; }

/* ===== PRODUCTOS ===== */
.product-card {
  transition: all 0.3s ease;
  border-radius: 16px;
  background: #fff;
}
.product-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
}
.product-img-wrapper { overflow: hidden; border-radius: 16px 16px 0 0; }
.product-img {
  height: 220px;
  width: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}
.product-card:hover .product-img { transform: scale(1.05); }
.price-tag { font-size: 1.2rem; color: var(--primary-dark); }

/* ===== MODAL ===== */
.modal-content { border-radius: 16px; overflow: hidden; }
.modal-header { background-color: #dc3545 !important; }
.modal-footer .btn-secondary { background-color: var(--accent); color: #333; border: none; }
.modal-footer .btn-danger { background-color: #dc3545; border: none; }

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .catalog-header { padding: 30px 20px; }
  .product-img { height: 180px; }
  .filter-panel { padding: 15px; }
}
</style>
{% endblock %}