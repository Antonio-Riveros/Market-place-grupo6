{% extends "base.html" %}
{% block title %}Productos ‚Ä¢ Mercadito{% endblock %}

{% block content %}
<section class="catalog-header text-center py-5 mb-4">
  <div class="header-content">
    <h2 class="fw-bold display-6 text-gradient">Cat√°logo de Productos</h2>
    <p class="lead mt-2">Descubr√≠ lo mejor del Mercadito, todo en un solo lugar</p>

    {% if user.is_authenticated %}
    <a href="{% url 'market:productcreate' %}" class="btn btn-success mt-3 px-4 py-2 rounded-pill fw-semibold pulse-animation">
      <i class="bi bi-plus-circle me-2"></i>Publicar nuevo producto
    </a>
    {% endif %}
  </div>
</section>

<div class="container py-4">
  <!-- FILTROS MEJORADOS -->
  <div class="filter-panel card shadow-sm border-0 mb-5 p-3 bg-white">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="fw-bold text-primary mb-0">Filtrar productos</h5>
      <button class="btn btn-sm btn-outline-primary d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
        <i class="bi bi-funnel"></i> Filtros
      </button>
    </div>
    
    <div class="collapse d-md-block" id="filterCollapse">
      <form method="get" class="row align-items-center justify-content-center gy-3">
        <div class="col-md-4 col-sm-6">
          <label for="category" class="form-label fw-semibold">
            <i class="bi bi-tags me-1"></i>Categor√≠a
          </label>
          <select name="category" id="category" class="form-select shadow-sm">
            <option value="">Todas las categor√≠as</option>
            {% for cat in categories %}
            <option value="{{ cat }}" {% if request.GET.category == cat %}selected{% endif %}>
              {{ cat|capfirst }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4 col-sm-6">
          <label for="order" class="form-label fw-semibold">
            <i class="bi bi-sort-numeric-down me-1"></i>Ordenar por precio
          </label>
          <select name="order" id="order" class="form-select shadow-sm">
            <option value="">Sin ordenar</option>
            <option value="asc" {% if request.GET.order == "asc" %}selected{% endif %}>Menor a Mayor</option>
            <option value="desc" {% if request.GET.order == "desc" %}selected{% endif %}>Mayor a Menor</option>
          </select>
        </div>

        <div class="col-md-2 text-center">
          <button type="submit" class="btn btn-primary w-100 rounded-pill shadow-sm mt-3 mt-md-0 fw-semibold">
            <i class="bi bi-check-lg me-1"></i>Aplicar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- PRODUCTOS (MANTENIDOS DE LA VERSI√ìN ANTERIOR) -->
  <div class="row g-4">
    {% for product in products %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
      <div class="card h-100 border-0 shadow-sm product-card position-relative overflow-hidden">
        {% if product.image %}
        <div class="product-img-wrapper">
          <img src="{{ product.image.url }}" class="card-img-top product-img" alt="{{ product.title }}">
        </div>
        {% else %}
        <div class="bg-secondary text-white text-center py-5 rounded-top">
          <i class="bi bi-box-seam fs-1"></i>
        </div>
        {% endif %}

        <div class="card-body text-center d-flex flex-column">
          <h5 class="card-title fw-bold text-dark mb-2">{{ product.title }}</h5>
          <p class="text-muted small flex-grow-1">{{ product.description|truncatewords:18 }}</p>
          <p class="fs-5 fw-bold text-success mb-3 price-tag">${{ product.price }}</p>

          {% if user.is_authenticated %}
          <button class="btn btn-primary rounded-pill w-100 fw-semibold add-to-cart-btn" data-id="{{ product.id }}">
            Agregar al carrito
          </button>

          {% if user == product.seller %}
          <div class="d-flex justify-content-center gap-2 mt-2">
            <a href="{% url 'market:product-edit' product.id %}" class="btn btn-warning text-white btn-sm rounded-pill px-3">‚úèÔ∏è</a>
            <button class="btn btn-danger btn-sm rounded-pill px-3 js-open-delete-modal"
                    data-delete-url="{% url 'market:product-delete' product.id %}"
                    data-product-title="{{ product.title|escapejs }}">
              üóëÔ∏è
            </button>
          </div>
          {% endif %}
          {% else %}
          <a href="{% url 'account_login' %}" class="btn btn-outline-secondary rounded-pill w-100">
            Inici√° sesi√≥n para comprar
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    {% empty %}
    <p class="text-center text-muted mt-5">No hay productos disponibles.</p>
    {% endfor %}
  </div>
</div>

<!-- Modal √∫nico para confirmar eliminaci√≥n (MANTENIDO DE LA VERSI√ìN ANTERIOR) -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header bg-danger text-white rounded-top-4">
        <h5 class="modal-title fw-bold" id="deleteModalLabel">‚ö†Ô∏è Confirmar eliminaci√≥n</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center py-4">
        <p class="fs-5 text-dark mb-0">
          ¬øEst√°s seguro de que quer√©s eliminar <strong id="deleteModalProductTitle"></strong>?
        </p>
      </div>

      <div class="modal-footer justify-content-center border-0 pb-4">
        <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
        <form id="deleteModalForm" method="post" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger rounded-pill px-4">Eliminar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Toasts (MANTENIDOS DE LA VERSI√ìN ANTERIOR) -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 2000;">
  <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert">
    <div class="d-flex">
      <div class="toast-body">Producto agregado al carrito ‚úì</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  <div id="toastError" class="toast align-items-center text-bg-danger border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body">‚ö†Ô∏é No se pudo conectar con el servidor.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Funci√≥n para obtener el token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener("DOMContentLoaded", () => {
    const toastSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
    const toastError = new bootstrap.Toast(document.getElementById('toastError'));

    // --- AGREGAR AL CARRITO - VERSI√ìN MEJORADA ---
    document.querySelectorAll(".add-to-cart-btn").forEach(btn => {
        // Remover event listeners anteriores para evitar duplicados
        btn.replaceWith(btn.cloneNode(true));
    });

    // Re-asignar event listeners a los botones nuevos
    document.querySelectorAll(".add-to-cart-btn").forEach(btn => {
        btn.addEventListener("click", function handleCartClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Si ya est√° procesando, ignorar clics adicionales
            if (this.disabled) return;
            
            const productId = this.dataset.id;
            const originalText = this.innerHTML;
            
            this.disabled = true;
            this.innerHTML = "Agregando...";
            
            console.log("üõí Agregando producto:", productId);
            
            // ‚úÖ USANDO POST CON CSRF TOKEN
            fetch(`/market/add/${productId}/`, {
                method: "POST",
                headers: { 
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": getCookie("csrftoken")
                }
            })
            .then(response => response.json())
            .then(data => {
                this.innerHTML = originalText;
                this.disabled = false;
                
                if (data.success) {
                    toastSuccess.show();
                    console.log("‚úÖ Producto agregado:", data.product);
                    
                    // NOTIFICAR AL CARRITO QUE SE ACTUALICE
                    const productAddedEvent = new Event('productAddedToCart');
                    document.dispatchEvent(productAddedEvent);
                    
                    // Tambi√©n disparar el evento gen√©rico
                    const cartUpdatedEvent = new Event('cartUpdated');
                    document.dispatchEvent(cartUpdatedEvent);
                } else {
                    toastError.show();
                }
            })
            .catch((error) => {
                this.innerHTML = originalText;
                this.disabled = false;
                toastError.show();
                console.error("‚ùå Error:", error);
            });
        });
    });

    // --- MODAL DE ELIMINACI√ìN (MANTENIDO DE LA VERSI√ìN ANTERIOR) ---
    const modalEl = document.getElementById('deleteModal');
    const deleteModal = new bootstrap.Modal(modalEl, {
        backdrop: true,
        keyboard: true
    });

    const modalForm = document.getElementById('deleteModalForm');
    const titleEl = document.getElementById('deleteModalProductTitle');

    document.querySelectorAll('.js-open-delete-modal').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const deleteUrl = btn.dataset.deleteUrl;
            const productTitle = btn.dataset.productTitle || 'este producto';
            titleEl.textContent = productTitle;
            modalForm.action = deleteUrl;
            deleteModal.show();
        });
    });

    // --- CERRAR MODAL CORRECTAMENTE (MANTENIDO DE LA VERSI√ìN ANTERIOR) ---
    modalEl.addEventListener('hidden.bs.modal', () => {
        document.body.classList.remove('modal-open');
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.remove();
    });
});
</script>

<style>
:root {
  --primary: #4361ee;
  --primary-dark: #3a56d4;
  --secondary: #7209b7;
  --success: #4cc9f0;
  --danger: #f72585;
  --warning: #f8961e;
  --light: #f8f9fa;
  --dark: #212529;
  --gradient-primary: linear-gradient(135deg, #4361ee, #3a0ca3);
  --gradient-secondary: linear-gradient(135deg, #7209b7, #4361ee);
  --gradient-danger: linear-gradient(135deg, #f72585, #b5179e);
  --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
  --border-radius: 12px;
}

/* ===== HERO MEJORADO ===== */
.catalog-header {
  background: var(--gradient-primary);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow-lg);
  max-width: 900px;
  margin: 0 auto;
  position: relative;
  overflow: hidden;
}

.catalog-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  z-index: 0;
}

.catalog-header .header-content {
  position: relative;
  z-index: 1;
}

.text-gradient {
  background: linear-gradient(to right, #ffffff, #e9ecef);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.catalog-header p {
  color: rgba(255, 255, 255, 0.9);
}

/* ===== FILTROS MEJORADOS ===== */
.filter-panel {
  border-radius: var(--border-radius);
  transition: all 0.3s ease;
}

.filter-panel:hover {
  box-shadow: var(--shadow-md);
}

.filter-panel summary {
  cursor: pointer;
  list-style: none;
  font-size: 1.1rem;
}
.filter-panel summary::marker { display: none; }
.filter-panel form { margin-top: 10px; }

/* ===== BOTONES MEJORADOS ===== */
.btn-primary {
  background: var(--primary);
  border: none;
  transition: all 0.3s ease;
}

.btn-primary:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);
}

.btn-success {
  background: var(--success);
  border: none;
}

.btn-danger {
  background: var(--danger);
  border: none;
}

.pulse-animation {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(76, 201, 240, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(76, 201, 240, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(76, 201, 240, 0);
  }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .catalog-header { 
    padding: 30px 20px; 
    margin: 0 15px;
  }
  
  .filter-panel { 
    padding: 15px; 
  }
  
  .text-gradient {
    font-size: 2rem;
  }
}
</style>
{% endblock %}