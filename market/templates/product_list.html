{% extends "base.html" %}
{% block title %}Productos ‚Ä¢ Mercadito{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- T√≠tulo principal -->
  <h2 class="text-center fw-bold mb-5 display-6 text-primary">
    üõçÔ∏è Cat√°logo de Productos
  </h2>

  <!-- Bot√≥n para publicar -->
  {% if user.is_authenticated %}
  <div class="text-center mb-4">
    <a href="{% url 'market:productcreate' %}" class="btn btn-success px-4 py-2 rounded-pill shadow-sm fw-semibold">
      ‚ûï Publicar nuevo producto
    </a>
  </div>
  {% endif %}

  <!-- FILTROS -->
  <form method="get" class="card shadow-sm border-0 mb-5 p-3 bg-light">
    <div class="row align-items-center justify-content-center gy-3">
      <div class="col-md-4 col-sm-6">
        <label for="category" class="form-label fw-semibold">Categor√≠a</label>
        <select name="category" id="category" class="form-select">
          <option value="">Todas</option>
          {% for cat in categories %}
          <option value="{{ cat }}" {% if request.GET.category == cat %}selected{% endif %}>
            {{ cat|capfirst }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4 col-sm-6">
        <label for="order" class="form-label fw-semibold">Ordenar por precio</label>
        <select name="order" id="order" class="form-select">
          <option value="">Sin ordenar</option>
          <option value="asc" {% if request.GET.order == "asc" %}selected{% endif %}>Menor a Mayor</option>
          <option value="desc" {% if request.GET.order == "desc" %}selected{% endif %}>Mayor a Menor</option>
        </select>
      </div>

      <div class="col-md-2 text-center">
        <button type="submit" class="btn btn-primary w-100 rounded-pill shadow-sm mt-3 mt-md-0 fw-semibold">
          Filtrar üîç
        </button>
      </div>
    </div>
  </form>

  <!-- PRODUCTOS -->
  <div class="row g-4">
    {% for product in products %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
      <div class="card h-100 border-0 shadow-sm product-card position-relative">
        {% if product.image %}
        <img src="{{ product.image.url }}" class="card-img-top rounded-top product-img" alt="{{ product.title }}">
        {% else %}
        <div class="bg-secondary text-white text-center py-5 rounded-top">
          <i class="bi bi-box-seam fs-1"></i>
        </div>
        {% endif %}

        <div class="card-body text-center p-3 d-flex flex-column">
          <h5 class="card-title fw-bold text-dark mb-2">{{ product.title }}</h5>
          <p class="text-muted small flex-grow-1">{{ product.description|truncatewords:18 }}</p>

          <p class="fs-5 fw-bold text-success mb-3">${{ product.price }}</p>

          {% if user.is_authenticated %}
          <button class="btn btn-primary rounded-pill w-100 fw-semibold add-to-cart-btn" data-id="{{ product.id }}">
            üõí Agregar al carrito
          </button>

          {% if user == product.seller %}
          <div class="d-flex justify-content-center gap-2 mt-2">
            <a href="{% url 'market:product-edit' product.id %}" class="btn btn-warning text-white btn-sm rounded-pill px-3">‚úèÔ∏è</a>
            <a href="{% url 'market:product-delete' product.id %}" class="btn btn-danger btn-sm rounded-pill px-3">üóëÔ∏è</a>
          </div>
          {% endif %}
          {% else %}
          <a href="{% url 'account_login' %}" class="btn btn-outline-secondary rounded-pill w-100">
            Inicia sesi√≥n para comprar
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    {% empty %}
    <p class="text-center text-muted mt-5">No hay productos disponibles.</p>
    {% endfor %}
  </div>
</div>

<!-- Toasts -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 2000;">
  <div id="toastSuccess" class="toast align-items-center text-bg-success border-0 mb-2" role="alert">
    <div class="d-flex">
      <div class="toast-body">Producto agregado al carrito ‚úÖ</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>

  <div id="toastError" class="toast align-items-center text-bg-danger border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body">‚ö†Ô∏è No se pudo conectar con el servidor.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const addButtons = document.querySelectorAll(".add-to-cart-btn");
  const toastSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
  const toastError = new bootstrap.Toast(document.getElementById('toastError'));

  addButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const productId = btn.dataset.id;

      fetch(`/market/add/${productId}/`, {
        method: "GET",
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            toastSuccess.show();
            if (typeof loadCart === "function") loadCart();
          } else {
            toastError.show();
          }
        })
        .catch(() => toastError.show());
    });
  });
});
</script>

<style>
.product-card {
  transition: all 0.2s ease-in-out;
  border-radius: 1rem;
}
.product-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
}
.product-img {
  height: 200px;
  object-fit: cover;
}
</style>
{% endblock %}
{% endblock %}
